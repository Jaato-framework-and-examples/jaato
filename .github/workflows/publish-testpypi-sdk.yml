name: "Publish jaato-sdk to TestPyPI"

on:
  workflow_dispatch:

jobs:
  build-and-publish:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
    environment: testpypi-sdk
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install build
        run: pip install build

      - name: Check version not already on TestPyPI
        run: |
          version=$(python -c "
          import tomllib, pathlib
          data = tomllib.loads(pathlib.Path('pyproject.toml').read_text())
          print(data['project']['version'])
          ")
          echo "Package version: $version"
          status=$(curl -s -o /dev/null -w '%{http_code}' \
            "https://test.pypi.org/pypi/jaato-sdk/${version}/json")
          if [ "$status" = "200" ]; then
            echo "::error::Version ${version} of jaato-sdk already exists on TestPyPI"
            exit 1
          fi
          echo "Version ${version} is available for publishing"
        working-directory: jaato-sdk

      - name: Generate combined README
        run: python ../scripts/build_readme.py
        working-directory: jaato-sdk

      - name: Build package
        run: python -m build .
        working-directory: jaato-sdk

      - name: Publish to TestPyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          repository-url: https://test.pypi.org/legacy/
          packages-dir: jaato-sdk/dist/
