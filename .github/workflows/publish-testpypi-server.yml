name: "Publish jaato-server to TestPyPI"

on:
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: pip install -e jaato-sdk/ && pip install -e "jaato-server/.[dev]"

      - name: Run tests
        run: pytest shared/tests/ server/test_client.py server/test_workspace_command.py

  build-and-publish:
    needs: test
    runs-on: ubuntu-latest
    permissions:
      id-token: write
    environment: testpypi-server
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install build
        run: pip install build

      - name: Check version not already on TestPyPI
        run: |
          version=$(python -c "
          import tomllib, pathlib
          data = tomllib.loads(pathlib.Path('jaato-server/pyproject.toml').read_text())
          print(data['project']['version'])
          ")
          echo "Package version: $version"
          status=$(curl -s -o /dev/null -w '%{http_code}' \
            "https://test.pypi.org/pypi/jaato-server/${version}/json")
          if [ "$status" = "200" ]; then
            echo "::error::Version ${version} of jaato-server already exists on TestPyPI"
            exit 1
          fi
          echo "Version ${version} is available for publishing"

      - name: Build package
        run: python -m build jaato-server/

      - name: Publish to TestPyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          repository-url: https://test.pypi.org/legacy/
          packages-dir: jaato-server/dist/
