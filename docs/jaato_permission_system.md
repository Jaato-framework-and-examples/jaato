# JAATO Tool Call Permission System

## Executive Summary

JAATO implements a comprehensive permission system that gates tool execution, ensuring models cannot perform sensitive operations without explicit approval. The system supports multiple approval scopes (single use, turn, session), configurable policies (whitelist/blacklist), and various approval channels (console, webhook, file-based). Permissions are evaluated in a deterministic order, with blacklists taking priority over whitelists, and session rules overriding static configuration.

---

## Part 1: Permission Responses

When a tool requires permission, the user can respond with various approval scopes:

### Response Options

| Short | Full | Decision | Scope | Behavior |
|-------|------|----------|-------|----------|
| `y` | `yes` | ALLOW | Single | Execute this tool call once |
| `n` | `no` | DENY | Single | Block this execution |
| `once` | `once` | ALLOW_ONCE | Single | Execute without remembering |
| `a` | `always` | ALLOW_SESSION | Session | Add tool to session whitelist |
| `never` | `never` | DENY_SESSION | Session | Add tool to session blacklist |
| `t` | `turn` | ALLOW_TURN | Turn | Allow all remaining tools this turn |
| `i` | `idle` | ALLOW_UNTIL_IDLE | Idle | Allow until session goes idle |
| `all` | `all` | ALLOW_ALL | Session | Pre-approve all future requests |

### Scope Semantics

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    PERMISSION SCOPE HIERARCHY                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                      â”‚
â”‚  NARROWEST â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º WIDEST   â”‚
â”‚                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  once  â”‚ < â”‚  yes   â”‚ < â”‚  turn  â”‚ < â”‚  idle  â”‚ < â”‚   all   â”‚   â”‚
â”‚  â”‚        â”‚   â”‚        â”‚   â”‚        â”‚   â”‚        â”‚   â”‚         â”‚   â”‚
â”‚  â”‚ Single â”‚   â”‚ Single â”‚   â”‚ Until  â”‚   â”‚ Until  â”‚   â”‚ Session â”‚   â”‚
â”‚  â”‚  call  â”‚   â”‚ + learnâ”‚   â”‚ turn   â”‚   â”‚ idle   â”‚   â”‚  wide   â”‚   â”‚
â”‚  â”‚        â”‚   â”‚        â”‚   â”‚ ends   â”‚   â”‚        â”‚   â”‚         â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚  â”‚   no   â”‚              VS              â”‚ never  â”‚                 â”‚
â”‚  â”‚        â”‚                              â”‚        â”‚                 â”‚
â”‚  â”‚ Single â”‚                              â”‚ Sessionâ”‚                 â”‚
â”‚  â”‚ denial â”‚                              â”‚ block  â”‚                 â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Turn vs Idle Explained

**Turn Scope (`t`):**
- Approves all tools until the model finishes its current response
- Clears automatically when the turn ends
- Useful for: "I trust this sequence of operations"

**Idle Scope (`i`):**
- Approves all tools until the session becomes idle (no user input, no model activity)
- Persists across multiple consecutive model turns
- Useful for: "Let it run until I interact again"

```
User: "Refactor the authentication module"
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Turn 1: Model reads files, proposes changes                      â”‚
â”‚  â”œâ”€ readFile â†’ auto-approved (read-only)                         â”‚
â”‚  â”œâ”€ updateFile â†’ user responds 't' (turn approval)               â”‚
â”‚  â”œâ”€ updateFile â†’ allowed (turn suspension active)                â”‚
â”‚  â””â”€ updateFile â†’ allowed (turn suspension active)                â”‚
â”‚                                                                   â”‚
â”‚  Turn 1 ends â†’ Turn suspension CLEARS                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Turn 2: Model continues (still processing)                       â”‚
â”‚  â”œâ”€ updateFile â†’ needs NEW permission                            â”‚
â”‚  â””â”€ ...                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

vs.

User: "Refactor the authentication module"
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Turn 1: Model reads files, proposes changes                      â”‚
â”‚  â”œâ”€ readFile â†’ auto-approved (read-only)                         â”‚
â”‚  â”œâ”€ updateFile â†’ user responds 'i' (idle approval)               â”‚
â”‚  â”œâ”€ updateFile â†’ allowed (idle suspension active)                â”‚
â”‚  â””â”€ updateFile â†’ allowed (idle suspension active)                â”‚
â”‚                                                                   â”‚
â”‚  Turn 1 ends â†’ Idle suspension PERSISTS                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Turn 2: Model continues (still processing)                       â”‚
â”‚  â”œâ”€ updateFile â†’ allowed (idle suspension still active)          â”‚
â”‚  â””â”€ ...                                                          â”‚
â”‚                                                                   â”‚
â”‚  Session goes IDLE â†’ Idle suspension CLEARS                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Part 2: Policy Evaluation Order

Permission decisions follow a strict, deterministic evaluation order:

### Evaluation Pipeline

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    POLICY EVALUATION ORDER                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                      â”‚
â”‚  Tool Call: updateFile(path="src/main.py", content="...")           â”‚
â”‚           â”‚                                                          â”‚
â”‚           â–¼                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚  1. SUSPENSION CHECK                                     â”‚        â”‚
â”‚  â”‚     â”œâ”€ _idle_suspended? â†’ ALLOW                         â”‚        â”‚
â”‚  â”‚     â”œâ”€ _turn_suspended? â†’ ALLOW                         â”‚        â”‚
â”‚  â”‚     â””â”€ _allow_all?      â†’ ALLOW                         â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚           â”‚ (if not suspended)                                       â”‚
â”‚           â–¼                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚  2. SANITIZATION (if enabled)                            â”‚        â”‚
â”‚  â”‚     â”œâ”€ Shell injection detected?      â†’ DENY            â”‚        â”‚
â”‚  â”‚     â”œâ”€ Dangerous command patterns?    â†’ DENY            â”‚        â”‚
â”‚  â”‚     â””â”€ Path outside allowed scope?    â†’ DENY            â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚           â”‚ (if no violations)                                       â”‚
â”‚           â–¼                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚  3. SESSION BLACKLIST                                    â”‚        â”‚
â”‚  â”‚     â””â”€ Tool in session_blacklist?     â†’ DENY            â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚           â”‚ (if not blacklisted)                                     â”‚
â”‚           â–¼                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚  4. STATIC BLACKLIST (config file)                       â”‚        â”‚
â”‚  â”‚     â””â”€ Tool matches blacklist pattern? â†’ DENY           â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚           â”‚ (if not blacklisted)                                     â”‚
â”‚           â–¼                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚  5. SESSION WHITELIST                                    â”‚        â”‚
â”‚  â”‚     â””â”€ Tool in session_whitelist?     â†’ ALLOW           â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚           â”‚ (if not whitelisted)                                     â”‚
â”‚           â–¼                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚  6. STATIC WHITELIST (config file)                       â”‚        â”‚
â”‚  â”‚     â””â”€ Tool matches whitelist pattern? â†’ ALLOW          â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚           â”‚ (if not whitelisted)                                     â”‚
â”‚           â–¼                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚  7. DEFAULT POLICY                                       â”‚        â”‚
â”‚  â”‚     â”œâ”€ Session default override?  â†’ Use session default â”‚        â”‚
â”‚  â”‚     â””â”€ Static default             â†’ Use config default  â”‚        â”‚
â”‚  â”‚                                                          â”‚        â”‚
â”‚  â”‚     Values: "allow" | "deny" | "ask"                    â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Key Principle: Blacklist Always Wins

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  BLACKLIST PRIORITY RULE                                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                   â”‚
â”‚  Scenario 1: Conflicting Rules                                    â”‚
â”‚  â”œâ”€ Session blacklist: updateFile                                â”‚
â”‚  â”œâ”€ Session whitelist: updateFile                                â”‚
â”‚  â””â”€ Result: DENIED (blacklist checked first)                     â”‚
â”‚                                                                   â”‚
â”‚  Scenario 2: Pattern vs Exact                                     â”‚
â”‚  â”œâ”€ Session blacklist: "create*" (pattern)                       â”‚
â”‚  â”œâ”€ Session whitelist: "createPlan" (exact)                      â”‚
â”‚  â””â”€ Result: createPlan is ALLOWED (exact beats pattern)          â”‚
â”‚             createFile is DENIED (pattern applies)               â”‚
â”‚                                                                   â”‚
â”‚  Scenario 3: Session vs Static                                    â”‚
â”‚  â”œâ”€ Static whitelist: run                                        â”‚
â”‚  â”œâ”€ Session blacklist: run                                       â”‚
â”‚  â””â”€ Result: DENIED (session blacklist beats static whitelist)    â”‚
â”‚                                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Part 3: Auto-Approved Tools

Certain tools bypass the permission system entirely because they are inherently safe.

### What Makes a Tool Auto-Approved?

1. **Read-only operations** - Cannot modify system state
2. **User-initiated actions** - Already explicitly requested by user
3. **Deterministic calculations** - Pure functions with no side effects
4. **Response handlers** - Processing user's response to a question

### Auto-Approved Tools by Plugin

| Plugin | Tools | Reason |
|--------|-------|--------|
| **introspection** | `list_tools`, `get_tool_schemas` | Discovery only |
| **file_edit** | `readFile`, `undoFileChange` | Read-only or reversible |
| **web_search** | `web_search` | Read-only, no system modification |
| **web_fetch** | `webFetch` | Read-only HTTP GET |
| **calculator** | `calculate` | Pure computation |
| **environment** | `get_environment` | Read-only system info |
| **clarification** | `answerClarification` | User response handler |
| **memory** | `addMemory`, `getMemory` | User-controlled storage |
| **permission** | `permissions` | Meta-command for permission mgmt |
| **anthropic_auth** | Auth commands | User-initiated OAuth |
| **github_auth** | Auth commands | User-initiated OAuth |

### How Auto-Approval Works

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    AUTO-APPROVAL FLOW                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                      â”‚
â”‚  1. Plugin Registration                                              â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚     â”‚  class FileEditPlugin:                              â”‚          â”‚
â”‚     â”‚      def get_auto_approved_tools(self):             â”‚          â”‚
â”‚     â”‚          return ["readFile", "undoFileChange"]      â”‚          â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                              â”‚                                       â”‚
â”‚                              â–¼                                       â”‚
â”‚  2. Registry Collection                                              â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚     â”‚  registry.get_auto_approved_tools()                 â”‚          â”‚
â”‚     â”‚  â†’ ["readFile", "undoFileChange", "web_search", ...] â”‚         â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                              â”‚                                       â”‚
â”‚                              â–¼                                       â”‚
â”‚  3. Permission Plugin Whitelisting                                   â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚     â”‚  permission_plugin.add_whitelist_tools(auto_approved) â”‚        â”‚
â”‚     â”‚  # Adds to policy.whitelist_tools set               â”‚          â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                              â”‚                                       â”‚
â”‚                              â–¼                                       â”‚
â”‚  4. Tool Execution                                                   â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚     â”‚  Tool: readFile(path="config.json")                 â”‚          â”‚
â”‚     â”‚  Policy check: matches whitelist                    â”‚          â”‚
â”‚     â”‚  Result: ALLOW (no prompt shown)                    â”‚          â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Part 4: Whitelist and Blacklist Management

### Configuration File Structure

Permissions can be configured via `permissions.json`:

```json
{
  "defaultPolicy": "ask",
  "blacklist": {
    "tools": ["dangerous_tool", "rm_rf"],
    "patterns": ["sudo*", "kill*"],
    "arguments": {
      "run": {
        "command": ["rm -rf", "sudo", "chmod 777"]
      }
    }
  },
  "whitelist": {
    "tools": ["git_status", "npm_install"],
    "patterns": ["read*", "list*"]
  }
}
```

### Pattern Matching (Glob-Style)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  PATTERN EXAMPLES                                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                   â”‚
â”‚  "read*"     â†’ readFile, readDirectory, readConfig               â”‚
â”‚  "*File"     â†’ readFile, writeFile, updateFile                   â”‚
â”‚  "git_*"     â†’ git_status, git_commit, git_push                  â”‚
â”‚  "run"       â†’ run (exact match only)                            â”‚
â”‚  "*"         â†’ matches everything (use with caution)             â”‚
â”‚                                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### User Commands

| Command | Effect | Persistence |
|---------|--------|-------------|
| `permissions show` | Display current effective policy | Read-only |
| `permissions allow <pattern>` | Add to session whitelist | Session only |
| `permissions deny <pattern>` | Add to session blacklist | Session only |
| `permissions default <policy>` | Override default (allow/deny/ask) | Session only |
| `permissions check <tool>` | Test what decision a tool would get | Read-only |
| `permissions clear` | Reset all session modifications | Clears state |
| `permissions suspend` | Enable allow-all mode | Session only |
| `permissions resume` | Disable allow-all mode | Session only |
| `permissions status` | Show suspension state | Read-only |

### Session vs Static Rules

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                   â”‚
â”‚  STATIC (permissions.json)          SESSION (runtime)            â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€             â”‚
â”‚  â€¢ Loaded at startup                â€¢ Modified during session    â”‚
â”‚  â€¢ Persists across sessions         â€¢ Lost when session ends     â”‚
â”‚  â€¢ Defines base policy              â€¢ Overrides static rules     â”‚
â”‚  â€¢ Managed by editing file          â€¢ Managed via commands       â”‚
â”‚                                                                   â”‚
â”‚  Evaluation: Static â”€â”€â–º Session rules applied on top             â”‚
â”‚                                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Part 5: Permission Channels

The permission system is channel-agnostic. Different channels handle the user interaction:

### Channel Types

| Channel | Use Case | Communication |
|---------|----------|---------------|
| **ConsoleChannel** | Interactive terminal | stdin/stdout |
| **QueueChannel** | TUI applications | Queue-based I/O |
| **WebhookChannel** | External approval systems | HTTP POST/response |
| **FileChannel** | Separate approval processes | File-based |
| **ParentBridgedChannel** | Subagent mode | Parent agent forwarding |

### Console Channel Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    CONSOLE CHANNEL INTERACTION                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  ğŸ”’ Permission Required: updateFile                          â”‚    â”‚
â”‚  â”‚                                                              â”‚    â”‚
â”‚  â”‚  File: src/auth/login.py                                    â”‚    â”‚
â”‚  â”‚                                                              â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚    â”‚
â”‚  â”‚  â”‚  @@ -15,7 +15,8 @@                                      â”‚ â”‚    â”‚
â”‚  â”‚  â”‚   def authenticate(username, password):                 â”‚ â”‚    â”‚
â”‚  â”‚  â”‚  -    return check_credentials(username, password)      â”‚ â”‚    â”‚
â”‚  â”‚  â”‚  +    result = check_credentials(username, password)    â”‚ â”‚    â”‚
â”‚  â”‚  â”‚  +    log_attempt(username, result)                     â”‚ â”‚    â”‚
â”‚  â”‚  â”‚  +    return result                                     â”‚ â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚    â”‚
â”‚  â”‚                                                              â”‚    â”‚
â”‚  â”‚  [y]es  [n]o  [a]lways  [never]  [t]urn  [i]dle  [all]      â”‚    â”‚
â”‚  â”‚  > _                                                         â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Webhook Channel Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    WEBHOOK CHANNEL FLOW                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                      â”‚
â”‚  JAATO                              External Approval System         â”‚
â”‚    â”‚                                         â”‚                       â”‚
â”‚    â”‚  POST /approve                          â”‚                       â”‚
â”‚    â”‚  {                                      â”‚                       â”‚
â”‚    â”‚    "request_id": "abc123",              â”‚                       â”‚
â”‚    â”‚    "tool_name": "run",                  â”‚                       â”‚
â”‚    â”‚    "tool_args": {"command": "npm i"},   â”‚                       â”‚
â”‚    â”‚    "context": {...}                     â”‚                       â”‚
â”‚    â”‚  }                                      â”‚                       â”‚
â”‚    â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º â”‚                       â”‚
â”‚    â”‚                                         â”‚                       â”‚
â”‚    â”‚         (External review process)       â”‚                       â”‚
â”‚    â”‚                                         â”‚                       â”‚
â”‚    â”‚  Response:                              â”‚                       â”‚
â”‚    â”‚  {                                      â”‚                       â”‚
â”‚    â”‚    "request_id": "abc123",              â”‚                       â”‚
â”‚    â”‚    "decision": "allow",                 â”‚                       â”‚
â”‚    â”‚    "reason": "Approved by admin"        â”‚                       â”‚
â”‚    â”‚  }                                      â”‚                       â”‚
â”‚    â”‚ â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚                       â”‚
â”‚    â”‚                                         â”‚                       â”‚
â”‚                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Subagent Channel (ParentBridgedChannel)

When subagents need permissions, they route through their parent:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    SUBAGENT PERMISSION ROUTING                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚   SUBAGENT   â”‚          â”‚    PARENT    â”‚          â”‚   USER   â”‚  â”‚
â”‚  â”‚              â”‚          â”‚              â”‚          â”‚          â”‚  â”‚
â”‚  â”‚  updateFile  â”‚          â”‚              â”‚          â”‚          â”‚  â”‚
â”‚  â”‚      â”‚       â”‚          â”‚              â”‚          â”‚          â”‚  â”‚
â”‚  â”‚      â–¼       â”‚          â”‚              â”‚          â”‚          â”‚  â”‚
â”‚  â”‚  Permission  â”‚ â”€â”€XMLâ”€â”€â–º â”‚  Receives    â”‚          â”‚          â”‚  â”‚
â”‚  â”‚  request via â”‚ message  â”‚  request     â”‚ â”€â”€â”€â”€â”€â”€â–º  â”‚  Prompt  â”‚  â”‚
â”‚  â”‚  thread-localâ”‚          â”‚              â”‚          â”‚          â”‚  â”‚
â”‚  â”‚  channel     â”‚          â”‚              â”‚ â—„â”€â”€â”€â”€â”€â”€  â”‚  Responseâ”‚  â”‚
â”‚  â”‚              â”‚ â—„â”€â”€â”€â”€â”€â”€â”€ â”‚  Forwards    â”‚          â”‚          â”‚  â”‚
â”‚  â”‚      â–¼       â”‚ response â”‚  response    â”‚          â”‚          â”‚  â”‚
â”‚  â”‚  Continue    â”‚          â”‚              â”‚          â”‚          â”‚  â”‚
â”‚  â”‚  execution   â”‚          â”‚              â”‚          â”‚          â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                      â”‚
â”‚  Thread isolation ensures subagent doesn't affect parent's channel  â”‚
â”‚                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Part 6: Permission Display Formatting

Plugins can provide rich permission displays tailored to their tools.

### PermissionDisplayInfo Structure

```python
@dataclass
class PermissionDisplayInfo:
    summary: str                          # "Update file: src/main.py"
    details: str                          # Full diff content
    format_hint: str = "text"             # "diff", "json", "text", "code"
    language: Optional[str] = None        # For syntax highlighting
    truncated: bool = False               # Content was truncated
    original_lines: Optional[int] = None  # Pre-truncation line count
    warnings: Optional[str] = None        # Security warnings
    warning_level: Optional[str] = None   # "info", "warning", "error"
```

### Plugin Integration

```python
class FileEditPlugin:
    def format_permission_request(
        self,
        tool_name: str,
        args: Dict[str, Any],
        channel_type: str
    ) -> Optional[PermissionDisplayInfo]:

        if tool_name == "updateFile":
            # Generate unified diff
            diff = generate_diff(args['path'], args['content'])

            return PermissionDisplayInfo(
                summary=f"Update file: {args['path']}",
                details=diff,
                format_hint="diff",
                language="python" if args['path'].endswith('.py') else None,
                truncated=len(diff.splitlines()) > 100,
                original_lines=len(diff.splitlines())
            )

        return None  # Use default formatting
```

### Display Examples by Tool Type

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  FILE EDIT (format_hint="diff")                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  @@ -10,5 +10,7 @@                                                â”‚
â”‚   class User:                                                     â”‚
â”‚       def __init__(self, name):                                   â”‚
â”‚  -        self.name = name                                        â”‚
â”‚  +        self.name = name                                        â”‚
â”‚  +        self.created_at = datetime.now()                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  SHELL COMMAND (format_hint="code")                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Command: npm install express@4.18.2                              â”‚
â”‚                                                                   â”‚
â”‚  Working directory: /home/user/project                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  WEB FETCH (format_hint="text")                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  URL: https://api.github.com/repos/user/repo                     â”‚
â”‚  Method: GET                                                      â”‚
â”‚  Headers: Authorization: Bearer ***                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Part 7: Tool Execution Integration

The permission system integrates with `ToolExecutor` to gate all tool calls.

### Execution Flow with Permissions

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    TOOL EXECUTION WITH PERMISSIONS                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                      â”‚
â”‚  Model: "Call updateFile(path='x.py', content='...')"               â”‚
â”‚           â”‚                                                          â”‚
â”‚           â–¼                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  ToolExecutor.execute(name, args, callback, call_id)         â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚           â”‚                                                          â”‚
â”‚           â–¼                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  if self._permission_plugin:                                 â”‚    â”‚
â”‚  â”‚      allowed, perm_info = permission_plugin.check_permission(â”‚    â”‚
â”‚  â”‚          tool_name=name,                                     â”‚    â”‚
â”‚  â”‚          args=args,                                          â”‚    â”‚
â”‚  â”‚          context=self._permission_context,                   â”‚    â”‚
â”‚  â”‚          call_id=call_id                                     â”‚    â”‚
â”‚  â”‚      )                                                       â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚           â”‚                                                          â”‚
â”‚           â”œâ”€â”€â”€â”€â”€â”€â”€ if not allowed â”€â”€â”€â”€â”€â”€â–º  Return error with        â”‚
â”‚           â”‚                                 _permission metadata     â”‚
â”‚           â”‚                                                          â”‚
â”‚           â–¼ (if allowed)                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  Execute tool                                                â”‚    â”‚
â”‚  â”‚  result = executor(args)                                     â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚           â”‚                                                          â”‚
â”‚           â–¼                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  Inject permission metadata into result                      â”‚    â”‚
â”‚  â”‚  result['_permission'] = {                                   â”‚    â”‚
â”‚  â”‚      'decision': 'allowed',                                  â”‚    â”‚
â”‚  â”‚      'reason': 'User approved',                              â”‚    â”‚
â”‚  â”‚      'method': 'user_approved'                               â”‚    â”‚
â”‚  â”‚  }                                                           â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚           â”‚                                                          â”‚
â”‚           â–¼                                                          â”‚
â”‚  Return (success=True, result)                                      â”‚
â”‚                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Permission Metadata in Results

Every tool result includes `_permission` metadata:

```python
# Allowed execution
{
    "output": "File updated successfully",
    "_permission": {
        "decision": "allowed",
        "reason": "User approved",
        "method": "user_approved"
    }
}

# Denied execution
{
    "error": "Permission denied",
    "_permission": {
        "decision": "denied",
        "reason": "Tool is blacklisted",
        "method": "blacklist"
    }
}
```

### Method Values

| Method | Meaning |
|--------|---------|
| `user_approved` | User explicitly approved in channel |
| `whitelist` | Matched whitelist rule |
| `blacklist` | Matched blacklist rule (denied) |
| `default` | Default policy applied |
| `auto_approved` | Tool is auto-approved |
| `suspended` | Turn/idle/all suspension active |
| `timeout` | Channel timeout (configurable default) |
| `sanitization` | Sanitization check failed (denied) |

---

## Part 8: Thread Safety and Parallel Execution

When multiple tools execute in parallel, the permission system ensures safe, serialized prompts.

### Channel Lock

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    PARALLEL PERMISSION HANDLING                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                      â”‚
â”‚  Model: "Read config, update main.py, and create backup"            â”‚
â”‚           â”‚                                                          â”‚
â”‚           â”œâ”€â”€â–º Thread 1: readFile (auto-approved, no lock needed)   â”‚
â”‚           â”‚                                                          â”‚
â”‚           â”œâ”€â”€â–º Thread 2: updateFile                                 â”‚
â”‚           â”‚         â”‚                                                â”‚
â”‚           â”‚         â–¼                                                â”‚
â”‚           â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚           â”‚    â”‚  Acquire _channel_lock               â”‚            â”‚
â”‚           â”‚    â”‚  (blocks if another thread has it)   â”‚            â”‚
â”‚           â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚           â”‚         â”‚                                                â”‚
â”‚           â”‚         â–¼                                                â”‚
â”‚           â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚           â”‚    â”‚  Re-check suspensions                 â”‚            â”‚
â”‚           â”‚    â”‚  (another thread may have set 'all') â”‚            â”‚
â”‚           â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚           â”‚         â”‚                                                â”‚
â”‚           â”‚         â–¼                                                â”‚
â”‚           â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚           â”‚    â”‚  Show permission prompt               â”‚            â”‚
â”‚           â”‚    â”‚  User sees ONE prompt at a time      â”‚            â”‚
â”‚           â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚           â”‚         â”‚                                                â”‚
â”‚           â”‚         â–¼                                                â”‚
â”‚           â”‚    Release _channel_lock                                â”‚
â”‚           â”‚                                                          â”‚
â”‚           â””â”€â”€â–º Thread 3: writeNewFile                               â”‚
â”‚                     â”‚                                                â”‚
â”‚                     â–¼                                                â”‚
â”‚                Waits for lock (Thread 2 has it)                     â”‚
â”‚                     â”‚                                                â”‚
â”‚                     â–¼                                                â”‚
â”‚                Acquires lock after Thread 2 releases                â”‚
â”‚                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Call ID Matching

When multiple permissions are pending, `call_id` helps match responses:

```python
# Executor passes call_id
executor.execute("updateFile", args, callback, call_id="tool-call-123")

# Permission check includes call_id
permission_plugin.check_permission(..., call_id="tool-call-123")

# Event includes call_id for UI matching
PermissionInputModeEvent(call_id="tool-call-123", ...)
```

---

## Part 9: Server Events

The permission system emits events for client UI integration.

### Event Types

```python
# When permission prompt should be shown
@dataclass
class PermissionRequestedEvent(Event):
    agent_id: str                          # Which agent is requesting
    request_id: str                        # Unique request identifier
    tool_name: str                         # Tool being called
    tool_args: Dict[str, Any]              # Raw arguments
    response_options: List[Dict]           # Valid response options
    prompt_lines: Optional[List[str]]      # Pre-formatted prompt
    format_hint: Optional[str]             # "diff", "text", "code"
    warnings: Optional[str]                # Security warnings
    warning_level: Optional[str]           # "info", "warning", "error"

# When client should enter input mode
@dataclass
class PermissionInputModeEvent(Event):
    agent_id: str
    request_id: str
    call_id: Optional[str]                 # For parallel tool matching

# When permission has been resolved
@dataclass
class PermissionResolvedEvent(Event):
    agent_id: str
    request_id: str
    granted: bool                          # Was it approved?
    method: str                            # How was it decided?
```

### Event Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    PERMISSION EVENT SEQUENCE                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                      â”‚
â”‚  Server                                              Client          â”‚
â”‚    â”‚                                                    â”‚            â”‚
â”‚    â”‚  PermissionRequestedEvent                          â”‚            â”‚
â”‚    â”‚  {tool: "updateFile", args: {...},                â”‚            â”‚
â”‚    â”‚   prompt_lines: [...], format_hint: "diff"}       â”‚            â”‚
â”‚    â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º â”‚            â”‚
â”‚    â”‚                                                    â”‚            â”‚
â”‚    â”‚                                          Render permission      â”‚
â”‚    â”‚                                          panel with diff        â”‚
â”‚    â”‚                                                    â”‚            â”‚
â”‚    â”‚  PermissionInputModeEvent                          â”‚            â”‚
â”‚    â”‚  {request_id: "...", call_id: "..."}              â”‚            â”‚
â”‚    â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º â”‚            â”‚
â”‚    â”‚                                                    â”‚            â”‚
â”‚    â”‚                                          Focus input field      â”‚
â”‚    â”‚                                          Show response options  â”‚
â”‚    â”‚                                                    â”‚            â”‚
â”‚    â”‚  PermissionResponseRequest                         â”‚            â”‚
â”‚    â”‚  {request_id: "...", response: "y"}               â”‚            â”‚
â”‚    â”‚ â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚            â”‚
â”‚    â”‚                                                    â”‚            â”‚
â”‚    â”‚  PermissionResolvedEvent                           â”‚            â”‚
â”‚    â”‚  {granted: true, method: "user_approved"}         â”‚            â”‚
â”‚    â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º â”‚            â”‚
â”‚    â”‚                                                    â”‚            â”‚
â”‚    â”‚                                          Clear permission       â”‚
â”‚    â”‚                                          panel, resume normal   â”‚
â”‚    â”‚                                                    â”‚            â”‚
â”‚                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Part 10: Suspend and Resume

The permission system supports temporary suspension of all permission checks.

### Suspension States

| State | Set By | Cleared By | Behavior |
|-------|--------|------------|----------|
| `_turn_suspended` | User responds `t` | Turn ends | Allow all for current turn |
| `_idle_suspended` | User responds `i` | Session goes idle | Allow all until idle |
| `_allow_all` | User responds `all` or command | `permissions resume` | Allow all permanently |

### Suspension Priority

```python
# Check order in check_permission():
if self._idle_suspended:     # 1st: Idle suspension
    return True, {"method": "suspended", "reason": "Idle suspension active"}
if self._turn_suspended:     # 2nd: Turn suspension
    return True, {"method": "suspended", "reason": "Turn suspension active"}
if self._allow_all:          # 3rd: All suspension
    return True, {"method": "suspended", "reason": "All permissions suspended"}
# Otherwise: Use policy evaluation
```

### Lifecycle Integration

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    SUSPENSION LIFECYCLE                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                      â”‚
â”‚  User responds 'i' (idle)                                           â”‚
â”‚    â”‚                                                                 â”‚
â”‚    â–¼                                                                 â”‚
â”‚  _idle_suspended = True                                             â”‚
â”‚    â”‚                                                                 â”‚
â”‚    â”œâ”€â”€â–º Turn 1: All tools allowed                                   â”‚
â”‚    â”œâ”€â”€â–º Turn 2: All tools allowed                                   â”‚
â”‚    â”œâ”€â”€â–º Turn 3: All tools allowed                                   â”‚
â”‚    â”‚                                                                 â”‚
â”‚    â–¼                                                                 â”‚
â”‚  Session goes IDLE (no activity)                                    â”‚
â”‚    â”‚                                                                 â”‚
â”‚    â–¼                                                                 â”‚
â”‚  Server calls: permission_plugin.clear_idle_suspension()            â”‚
â”‚    â”‚                                                                 â”‚
â”‚    â–¼                                                                 â”‚
â”‚  _idle_suspended = False                                            â”‚
â”‚    â”‚                                                                 â”‚
â”‚    â–¼                                                                 â”‚
â”‚  Next tool call: Permission check required again                    â”‚
â”‚                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Part 11: Sanitization (Security Layer)

An optional security layer that runs before whitelist/blacklist evaluation.

### Sanitization Checks

| Check | Purpose | Examples Blocked |
|-------|---------|------------------|
| **Shell Injection** | Prevent command injection | `; rm -rf /`, `$(malicious)`, `` `cmd` `` |
| **Dangerous Commands** | Block destructive operations | `sudo`, `rm`, `chmod 777`, `kill -9` |
| **Path Scope** | Restrict file access | `../../etc/passwd`, `/root/.ssh` |

### Configuration

```python
# Enable sanitization
policy.set_sanitization(config={
    "shell_injection": True,
    "dangerous_commands": ["sudo", "rm", "chmod", "kill"],
    "allowed_paths": ["/home/user/project"]
}, cwd="/home/user/project")

# Or use strict sandbox mode
policy.enable_strict_sandbox(cwd="/home/user/project")
```

### Evaluation Position

```
Sanitization runs FIRST, before any whitelist/blacklist:

  Tool Call
      â”‚
      â–¼
  Sanitization â”€â”€â–º DENY (if violations found)
      â”‚
      â–¼ (if clean)
  Blacklist Check
      â”‚
      â–¼
  Whitelist Check
      â”‚
      â–¼
  Default Policy
```

---

## Part 12: Visual Summary

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    PERMISSION SYSTEM OVERVIEW                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                      â”‚
â”‚                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         â”‚
â”‚                         â”‚   TOOL CALL     â”‚                         â”‚
â”‚                         â”‚  updateFile()   â”‚                         â”‚
â”‚                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â”‚
â”‚                                  â”‚                                   â”‚
â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚              â–¼                                       â–¼              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚    AUTO-APPROVED?       â”‚          â”‚      SUSPENDED?         â”‚  â”‚
â”‚  â”‚                         â”‚          â”‚                         â”‚  â”‚
â”‚  â”‚  readFile       âœ“       â”‚          â”‚  _turn_suspended   âœ“    â”‚  â”‚
â”‚  â”‚  web_search     âœ“       â”‚          â”‚  _idle_suspended   âœ“    â”‚  â”‚
â”‚  â”‚  calculate      âœ“       â”‚          â”‚  _allow_all        âœ“    â”‚  â”‚
â”‚  â”‚  updateFile     âœ—       â”‚          â”‚                         â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚              â”‚                                       â”‚              â”‚
â”‚              â”‚ No                                    â”‚ No           â”‚
â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚                                  â–¼                                   â”‚
â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”‚
â”‚                    â”‚    POLICY EVALUATION    â”‚                      â”‚
â”‚                    â”‚                         â”‚                      â”‚
â”‚                    â”‚  1. Sanitization        â”‚                      â”‚
â”‚                    â”‚  2. Session Blacklist   â”‚                      â”‚
â”‚                    â”‚  3. Static Blacklist    â”‚                      â”‚
â”‚                    â”‚  4. Session Whitelist   â”‚                      â”‚
â”‚                    â”‚  5. Static Whitelist    â”‚                      â”‚
â”‚                    â”‚  6. Default Policy      â”‚                      â”‚
â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚
â”‚                                 â”‚                                    â”‚
â”‚           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚           â–¼                     â–¼                     â–¼             â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚     â”‚  ALLOW   â”‚         â”‚   DENY   â”‚         â”‚   ASK    â”‚         â”‚
â”‚     â”‚          â”‚         â”‚          â”‚         â”‚          â”‚         â”‚
â”‚     â”‚ Execute  â”‚         â”‚  Return  â”‚         â”‚  Channel â”‚         â”‚
â”‚     â”‚ tool     â”‚         â”‚  error   â”‚         â”‚  prompt  â”‚         â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                                                     â”‚                â”‚
â”‚                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚                                    â–¼                             â–¼  â”‚
â”‚                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚                              â”‚   USER   â”‚                 â”‚TIMEOUT â”‚â”‚
â”‚                              â”‚ RESPONSE â”‚                 â”‚        â”‚â”‚
â”‚                              â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                 â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜â”‚
â”‚                                   â”‚                           â”‚     â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤     â”‚
â”‚     â–¼           â–¼           â–¼     â–¼           â–¼               â–¼     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  y  â”‚    â”‚  n  â”‚    â”‚  a  â”‚ â”‚neverâ”‚    â”‚  t  â”‚        â”‚deny â”‚   â”‚
â”‚  â”‚     â”‚    â”‚     â”‚    â”‚     â”‚ â”‚     â”‚    â”‚     â”‚        â”‚ or  â”‚   â”‚
â”‚  â”‚Allowâ”‚    â”‚Deny â”‚    â”‚Add  â”‚ â”‚Add  â”‚    â”‚Turn â”‚        â”‚allowâ”‚   â”‚
â”‚  â”‚once â”‚    â”‚once â”‚    â”‚to WLâ”‚ â”‚to BLâ”‚    â”‚susp.â”‚        â”‚     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Part 13: Color Coding Suggestion for Infographic

- **Green:** Allow decisions (whitelist, auto-approved, user approved)
- **Red:** Deny decisions (blacklist, user denied, sanitization violation)
- **Yellow:** Ask/pending states (waiting for user input)
- **Blue:** Suspension states (turn, idle, all)
- **Gray:** Policy evaluation flow
- **Orange:** Channel communication
- **Purple:** Server events
