# Sequence Diagram Generator

Generate sequence diagrams from CLI vs MCP trace files, showing interactions between:
- **Client Script** - The entry point (cli_mcp_harness.py)
- **Orchestrator** - The ai_tool_runner framework
- **LLM** - The Gemini model
- **Plugin Tools** - CLI and MCP tools that are invoked

## Installation

The script requires `reportlab` for PDF generation (already in requirements.txt):

```bash
cd /path/to/jaato
.venv/bin/pip install -r requirements.txt
```

## Usage

### Generate PDF from a trace file

```bash
.venv/bin/python sequence-diagram-generator/trace_to_sequence.py \
  --trace cli_vs_mcp/traces/cli_get_page_run1.trace.json \
  -o diagram.pdf
```

### Generate PDF from a ledger file

```bash
.venv/bin/python sequence-diagram-generator/trace_to_sequence.py \
  --ledger cli_get_page_run1.jsonl \
  -o diagram.pdf
```

### Export PlantUML or Mermaid source

```bash
# Export PlantUML source
.venv/bin/python sequence-diagram-generator/trace_to_sequence.py \
  --trace traces/trace.json \
  --export-plantuml diagram.puml

# Export Mermaid source
.venv/bin/python sequence-diagram-generator/trace_to_sequence.py \
  --trace traces/trace.json \
  --export-mermaid diagram.mmd
```

### Custom title

```bash
.venv/bin/python sequence-diagram-generator/trace_to_sequence.py \
  --trace traces/trace.json \
  --title "My Custom Diagram Title" \
  -o diagram.pdf
```

### Choose rendering backend

```bash
# Use pure Python renderer (default, most reliable)
.venv/bin/python sequence-diagram-generator/trace_to_sequence.py \
  --trace traces/trace.json \
  -o diagram.pdf \
  --backend reportlab

# Use Mermaid CLI (requires mmdc installed)
.venv/bin/python sequence-diagram-generator/trace_to_sequence.py \
  --trace traces/trace.json \
  -o diagram.pdf \
  --backend mermaid

# Use PlantUML (requires Java and plantuml.jar)
.venv/bin/python sequence-diagram-generator/trace_to_sequence.py \
  --trace traces/trace.json \
  -o diagram.pdf \
  --backend plantuml
```

## Input Formats

### Trace JSON (`.trace.json`)

Generated by `cli_mcp_harness.py --trace`. Contains:
- `prompt`: Initial prompt sent to the model
- `text`: Final text response
- `summary.events`: List of events (token counts, tool calls, etc.)
- `tool_result.trace`: Per-turn trace data with function calls

### Ledger JSONL (`.jsonl`)

Token accounting ledger with one event per line:
- `pre-count`: Token counting events
- `response`: Model response with token usage
- `tool-call`: Function call invocations
- `tool-result`: Tool execution results
- `api-error`: Retry/error events

## Output

The generated PDF shows a UML sequence diagram with:
- Participant boxes at the top (Client, Orchestrator, LLM, Tools)
- Vertical lifelines
- Arrows showing message flow:
  - Solid arrows: Requests/calls
  - Dashed arrows: Returns/responses
- Message labels showing the operation and key parameters

## Rendering Backends

| Backend | Requirements | Notes |
|---------|--------------|-------|
| `reportlab` | `pip install reportlab` | Pure Python, default, most reliable |
| `mermaid` | `npm install -g @mermaid-js/mermaid-cli` | Requires Node.js |
| `plantuml` | Java + plantuml.jar | Requires Java runtime |

The `auto` backend (default) tries backends in order: reportlab > mermaid > plantuml

## Example Workflow

1. Run the harness with tracing enabled:
   ```bash
   .venv/bin/python cli_vs_mcp/cli_mcp_harness.py \
     --domain github \
     --scenarios list_issues \
     --domain-params '{"owner": "myorg", "repo": "myrepo"}' \
     --trace \
     --trace-dir cli_vs_mcp/traces
   ```

2. Generate sequence diagrams:
   ```bash
   # CLI trace
   .venv/bin/python sequence-diagram-generator/trace_to_sequence.py \
     --trace cli_vs_mcp/traces/cli_list_issues_run1.trace.json \
     -o cli_sequence.pdf

   # MCP trace
   .venv/bin/python sequence-diagram-generator/trace_to_sequence.py \
     --trace cli_vs_mcp/traces/mcp_list_issues_run1.trace.json \
     -o mcp_sequence.pdf
   ```

3. Compare the diagrams to see the difference in interaction patterns between CLI and MCP tool execution.
